{% extends 'base.html' %}
{% load static %}

{% block page_header %}
<!-- Header-->
<!--<header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Sneaker Dadi's got you covered..(products.html)</h1>
            <p class="lead fw-normal text-white-50 mb-0">Check out our fantastic Adidas footwear deals!</p>
        </div>
    </div>
</header>-->
{% endblock %}

{% block content %}
<!-- Product section-->
<section class="pt-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="row gx-4 gx-lg-5 align-items-center">
            <div class="col-md-6">
                <!-- Product image-->
                {% if product.image1 %}
                <img class="card-img-top mb-5 mb-md-0" src="{{ product.image1.url }}" alt="{{ product.name }}" />
                {% else %}
                <img class="card-img-top mb-5 mb-md-0" src="{{ MEDIA_URL }}noimage.png" alt="{{ product.name }}" />
                {% endif %}
            </div>
            <div class="col-md-6 rating">
                <div class="small mb-1">Product ID: {{ product.product_id }}
                    {% if request.user.is_superuser %}
                    <span class="ms-3">
                        <a href="{% url 'edit_product' product.id %}">Edit</a> |
                        <a class="text-danger" href="{% url 'delete_product' product.id %}">Delete</a>
                    </span>
                    {% endif %}
                </div>

                <div class="h1 display-5 fw-bolder">{{ product.name }}
                    {% if product.on_sale is True %}
                    <!-- Sale badge-->
                    <span id="badge-size" class="badge bg-danger text-white ms-1">Sale
                    </span>
                    {% endif %}
                </div>
                <!-- Product reviews-->
                <div class="rating-title">
                    {% if reviews %}
                    <small class="text-muted">
                        <!-- Average star rating -->
                        <!-- Credit: https://stackoverflow.com/questions/1107737/numeric-for-loop-in-django-templates/14389078#14389078 -->
                        {% with ''|center:avg_reviews.avg_rating as range %}
                        {% for _ in range %}
                        <i class="bi bi-star-fill text-warning"></i>
                        {% endfor %}
                        {% endwith %}
                        <!-- Average rating -->
                        <span class="avg-rating ms-2">{{ avg_reviews.avg_rating|floatformat:"1" }}</span>/5</small>
                    {% else %}
                    <small class="text-muted">
                        <i class="no-rating">No Rating</i><span class="avg-stars"></span><span
                            class="avg-rating ms-2"></span></small>
                    {% endif %}
                </div>
                <div>
                    <small class="text-muted">Price:</small>
                    {% if product.on_sale is True %}
                    <span class="text-decoration-line-through fs-5">£{{ product.price }}</span>
                    <span class="fs-5 text-danger">£{{ product.get_sale_price }}</span>
                    {% else %}
                    <span class="fs-5">£{{ product.price }}</span>
                    {% endif %}
                </div>
                {% if product.category %}
                <p class="small mt-1 mb-5">
                    <!--<i class="bi bi-collection"></i>-->
                    <span id="text-category"><strong>Category:</strong></span>
                    <a href="{% url 'products' %}?category={{ product.category.name }}">
                        {{ product.category.friendly_name }}
                    </a>
                </p>
                {% endif %}
                <p class="lead">{{ product.description }}</p>
                <form class="form" action="{% url 'add_to_cart' product.id %}" method="POST">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="col-12">
                            <p class="mt-1 me-3"><strong>Size:</strong></p>
                            <select class="form-control mb-3" id="size" name="size" style="max-width: 6rem" required>
                                <option value="" selected>Select</option>
                                {% for size in product.size %}
                                <option value="{{ size }}">{{ size }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!--<input class="form-control text-center me-3" id="inputQuantity" type="num" value="1"
                        style="max-width: 3rem" />-->
                    <div class="col-12">
                        <a href="{% url 'products' %}" class="btn btn-outline-dark">
                            <span class="icon">
                                <i class="bi bi-chevron-left"></i>
                            </span>
                            <span class="text-uppercase">Continue Shopping</span>
                        </a>
                        <button class="btn btn-outline-dark flex-shrink-0" type="submit">
                            <i class="bi-cart-fill me-1"></i>
                            Add to cart
                        </button>
                        <input type="hidden" name="quantity" value=1>
                        <input type="hidden" name="redirect_url" value="{{ request.path }}">
                    </div>
            </div>
            </form>
        </div>
    </div>
    </div>
</section>
<!-- Product Review section-->
<!-- Credit: Code Artisan Lab - https://www.youtube.com/watch?v=7tyMyLCjKVg&list=PLgnySyq8qZmrxJvJbZC1eb7PD4bu0a-sB&index=31 -->
<section>
    <div class="container px-4 px-lg-5 my-5">
        <hr>
        <h2 class="fw-bolder mb-4 review-heading">Reviews ({{ num_reviews }})
            {% if user.is_authenticated %}
            {% if can_add_review %}
            <span><button type="button" id="btn-review" class="btn btn-warning btn-sm mb-2 ms-2" data-bs-toggle="modal"
                    data-bs-target="#productReview">Add Review</button></span>
            {% endif %}
            {% endif %}
        </h2>
        <!-- Add Product Review Modal -->
        {% if user.is_authenticated %}
        {% if can_add_review %}
        <div class="modal fade" id="productReview" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productReviewLabel">Add Product Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="addForm" action="{% url 'save-review' product.id %}">
                            {% csrf_token %}
                            <table class="table">
                                {{reviewForm.as_table}}
                                <tr>
                                    <td colspan="2">
                                        <button type="submit"
                                            class="btn btn-primary float-end ms-1 me-4">Submit</button>
                                        <input type="reset" class="btn btn-dark float-end" value="Reset" id="reset" />
                                    </td>
                                </tr>
                            </table>
                            <!--<p class="ajaxRes"></p>-->
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
        <!-- End Product Review Modal -->

        <div class="col-md-6">
            <!--<div class="card">-->
            <!--<div class="card-body review-list">-->
            <!--<hr>-->
            <div class="review-list">
                <!-- Detail -->
                {% if reviews %}
                {% for review in reviews reversed %}
                <blockquote class="blockquote text-right">
                    <cite title="Source Title">
                        {% for star in review.review_rating|ljust:review.review_rating %}
                        <i class="bi bi-star-fill text-warning"></i>
                        {% endfor %}
                        {% if request.user.username == review.user.username %}
                        <!--<button type="button" class="btn btn-secondary btn-sm mb-2 ms-2 float-end"
                            data-bs-toggle="modal" data-bs-target="#editReview">Edit</button>-->
                        <!--<button type="button" class="btn btn-danger btn-sm mb-2 ms-2 float-end"
                                data-bs-toggle="modal" data-bs-target="#editReview">Delete</button>-->

                        <button type="button" id="" class="btn btn-warning btn-sm mb-2 ms-2" data-bs-toggle="modal"
                            data-bs-target="#editReview">Edit Review</button>
                        <a href="{% url 'delete-review' review.id %}" id="delete-review" type="button"
                            class="btn btn-danger btn-sm mb-2 ms-2 float-end">Delete</a>
                        {% endif %}
                    </cite>
                    <p>{{ review.review_text }}</p>
                    <footer class="blockquote-footer">{{ review.user|title }},
                        <span>{{ review.created_on|date:"d F Y" }}</span>
                    </footer>
                    <!--<footer class="blockquote-footer">{{ review.created_on }}
                    </footer>-->
                </blockquote>
                <hr />
                {% endfor %}
                {% else %}
                <i class="no-data">No reviews yet.</i>
                {% endif %}
            </div>
            <!--</div>-->
            <!-- Add Product Review Modal -->
            {% if user.is_authenticated %}

            <div class="modal fade" id="editReview" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editReviewLabel">Add Product Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form method="post" id="editForm" action="">
                                {% csrf_token %}
                                <table class="table">
                                    {{reviewForm.as_table}}
                                    <tr>
                                        <td colspan="2">
                                            <button type="submit"
                                                class="btn btn-primary float-end ms-1 me-4">Submit</button>
                                            <input type="reset" class="btn btn-dark float-end" value="Reset"
                                                id="reset" />
                                        </td>
                                    </tr>
                                </table>
                                <!--<p class="ajaxRes"></p>-->
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}
            <!-- End Edit Product Review Modal -->
        </div>
    </div>
</section>
<!-- Related items section-->
<section class="py-5 bg-light">
    <div class="container px-4 px-lg-5 mt-5">
        <h2 class="fw-bolder mb-4">Related products</h2>
        {% if product.gender == "m" %}
        <!-- Check if no male related products -->
        {% if not related_products_male %}
        <i>No related products.</i>
        {% else %}
        <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
            {% for product in related_products_male %}
            <!-- Male related products -->
            <div class="col mb-5">
                <div class="card h-100">
                    {% if product.on_sale is True %}
                    <!-- Sale badge-->
                    <div class="badge bg-danger text-white position-absolute" style="top: 0.5rem; right: 0.5rem">Sale
                    </div>
                    {% endif %}
                    <!-- Product image-->
                    {% if product.image1 %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img class="card-img-top" src="{{ product.image1.url }}" alt="{{ product.name }}" />
                    </a>
                    {% else %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img class="card-img-top" src="{{ MEDIA_URL }}noimage.png" alt="{{ product.name }}" />
                    </a>
                    {% endif %}
                    <!-- Product details-->
                    <div class="card-body card-body-home">
                        <div class="text-center">
                            <!-- Product name-->
                            <h5 class="fw-bolder">{{ product.name }}</h5>
                            <!-- Product reviews-->
                            {% if product.reviews %}
                            {% if product.get_average_rating == 0 %}
                            <small class="text-muted">No Rating</small>
                            {% else %}
                            <small class="text-muted">
                                <!-- Average star rating -->
                                {% with ''|center:product.get_average_rating as range %}
                                {% for _ in range %}
                                <i class="bi bi-star-fill text-warning"></i>
                                {% endfor %}
                                {% endwith %}
                                <!-- Average rating -->
                                <span
                                    class="avg-rating ms-2">{{ product.get_average_rating|floatformat:"1" }}</span>/5</small>
                            {% endif %}
                            {% endif %}
                            {% if request.user.is_superuser %}
                            <p class="ms-3 remove-margin">
                                <a class="small" href="{% url 'edit_product' product.id %}">Edit</a> |
                                <a class="small text-danger" href="{% url 'delete_product' product.id %}">Delete</a>
                            </p>
                            {% endif %}
                            <!-- Product price-->
                            {% if product.on_sale is True %}
                            <p>
                                <span class="text-decoration-line-through">£{{ product.price }}</span>
                                <span class="text-danger fw-bold">£{{ product.get_sale_price }}</span></p>
                            {% else %}
                            <p>£{{ product.price }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% else %}
        <!-- Check if no female related products -->
        {% if not related_products_female %}
        <i>No related products.</i>
        {% else %}
        <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
            {% for product in related_products_female %}
            <!-- Female related products -->
            <div class="col mb-5">
                <div class="card h-100">
                    {% if product.on_sale is True %}
                    <!-- Sale badge-->
                    <div class="badge bg-danger text-white position-absolute" style="top: 0.5rem; right: 0.5rem">Sale
                    </div>
                    {% endif %}
                    <!-- Product image-->
                    {% if product.image1 %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img class="card-img-top" src="{{ product.image1.url }}" alt="{{ product.name }}" />
                    </a>
                    {% else %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img class="card-img-top" src="{{ MEDIA_URL }}noimage.png" alt="{{ product.name }}" />
                    </a>
                    {% endif %}
                    <!-- Product details-->
                    <div class="card-body card-body-home">
                        <div class="text-center">
                            <!-- Product name-->
                            <h5 class="fw-bolder">{{ product.name }}</h5>
                            <!-- Product reviews-->
                            {% if product.reviews %}
                            {% if product.get_average_rating == 0 %}
                            <small class="text-muted">No Rating</small>
                            {% else %}
                            <small class="text-muted">
                                <!-- Average star rating -->
                                {% with ''|center:product.get_average_rating as range %}
                                {% for _ in range %}
                                <i class="bi bi-star-fill text-warning"></i>
                                {% endfor %}
                                {% endwith %}
                                <!-- Average rating -->
                                <span
                                    class="avg-rating ms-2">{{ product.get_average_rating|floatformat:"1" }}</span>/5</small>
                            {% endif %}
                            {% endif %}
                            {% if request.user.is_superuser %}
                            <p class="ms-3 remove-margin">
                                <a class="small" href="{% url 'edit_product' product.id %}">Edit</a> |
                                <a class="small text-danger" href="{% url 'delete_product' product.id %}">Delete</a>
                            </p>
                            {% endif %}
                            <!-- Product price-->
                            {% if product.on_sale is True %}
                            <p>
                                <span class="text-decoration-line-through">£{{ product.price }}</span>
                                <span class="text-danger fw-bold">£{{ product.get_sale_price }}</span></p>
                            {% else %}
                            <p>£{{ product.price }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script src="{% static 'products/js/product_review.js' %}"></script>
{% endblock %}